#!/usr/bin/env bash
# This is an optional compile script that can override the default Python buildpack behavior
# It ensures uv is available and used for dependency installation

set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Custom compile script with uv support"

# Export environment variables from ENV_DIR
if [ -d "$ENV_DIR" ]; then
    for e in $(ls $ENV_DIR); do
        export "$e=$(cat $ENV_DIR/$e)"
    done
fi

# Ensure uv is in PATH
export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"

# Check if uv is available and copy it to app bin directory for runtime access
if command -v uv &> /dev/null; then
    echo "       Using uv for dependency management"
    
    # Copy uv to build directory bin for runtime access
    mkdir -p $BUILD_DIR/bin
    UV_PATH=$(which uv)
    cp "$UV_PATH" "$BUILD_DIR/bin/uv"
    echo "       Copied uv to $BUILD_DIR/bin/uv for runtime access"
    
    # Change to build directory
    cd $BUILD_DIR
    
    # Don't install dependencies here - let the Python buildpack handle it
    echo "       Letting Python buildpack handle dependency installation"
    
else
    echo "       WARNING: uv not found during compile"
fi